{% extends 'fundamentos/base.html' %}

{% block title %}Busca - STJ Fundamentos Legais{% endblock %}

{% block content %}
<div x-data="buscaApp()" x-cloak>
    <!-- Estat√≠sticas -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
        <div class="bg-white rounded-lg shadow p-4 text-center">
            <div class="text-3xl font-bold text-blue-600">{{ stats.total }}</div>
            <div class="text-gray-600 text-sm">Total de Fundamentos</div>
        </div>
        {% for tipo, count in stats.tipos.items %}
        <div class="bg-white rounded-lg shadow p-4 text-center">
            <div class="text-2xl font-bold text-green-600">{{ count }}</div>
            <div class="text-gray-600 text-sm">{{ tipo }}</div>
        </div>
        {% endfor %}
    </div>

    <!-- Formul√°rio de busca -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
        <h2 class="text-xl font-semibold mb-4">üîç Buscar Fundamentos</h2>
        
        <div class="grid md:grid-cols-4 gap-4 mb-4">
            <div class="md:col-span-2">
                <label class="block text-sm font-medium text-gray-700 mb-1">Termo de busca</label>
                <input type="text" x-model="termo" @keyup.enter="buscar"
                    class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    placeholder="Digite para buscar...">
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de Recurso</label>
                <select x-model="tipo" class="w-full border rounded-lg px-4 py-2">
                    <option value="">Todos</option>
                    {% for t in tipos %}
                    <option value="{{ t.value }}">{{ t.label }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Categoria</label>
                <select x-model="categoria" class="w-full border rounded-lg px-4 py-2">
                    <option value="">Todas</option>
                    {% for c in categorias %}
                    <option value="{{ c.value }}">{{ c.label }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <div class="flex gap-4">
            <button @click="buscar" 
                class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition">
                Buscar
            </button>
            <button @click="limpar" 
                class="bg-gray-200 text-gray-700 px-6 py-2 rounded-lg hover:bg-gray-300 transition">
                Limpar
            </button>
        </div>
    </div>

    <!-- Resultados -->
    <div x-show="loading" class="text-center py-8">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
        <p class="mt-4 text-gray-600">Buscando...</p>
    </div>

    <div x-show="resultados.length > 0 && !loading">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold">
                <span x-text="totalResultados"></span> resultados encontrados
            </h3>
        </div>

        <div class="bg-white rounded-lg shadow overflow-hidden">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Seq</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Descri√ß√£o</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tipo</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Categoria</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">A√ß√µes</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    <template x-for="item in resultados" :key="item.seq">
                        <tr class="hover:bg-gray-50 tree-item">
                            <td class="px-4 py-3 text-sm font-mono" x-text="item.seq"></td>
                            <td class="px-4 py-3 text-sm" x-text="item.descricao"></td>
                            <td class="px-4 py-3 text-sm">
                                <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs" 
                                    x-text="item.tipo_recurso"></span>
                            </td>
                            <td class="px-4 py-3 text-sm">
                                <span class="px-2 py-1 bg-green-100 text-green-800 rounded text-xs" 
                                    x-text="item.categoria"></span>
                            </td>
                            <td class="px-4 py-3 text-sm">
                                <a :href="'/detalhe/' + item.seq + '/'" 
                                    class="text-blue-600 hover:underline">Ver detalhes</a>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>

        <!-- Pagina√ß√£o -->
        <div class="mt-4 flex justify-center gap-2" x-show="totalPaginas > 1">
            <button @click="paginaAnterior" :disabled="pagina === 1"
                class="px-4 py-2 bg-gray-200 rounded disabled:opacity-50">Anterior</button>
            <span class="px-4 py-2">P√°gina <span x-text="pagina"></span> de <span x-text="totalPaginas"></span></span>
            <button @click="proximaPagina" :disabled="pagina >= totalPaginas"
                class="px-4 py-2 bg-gray-200 rounded disabled:opacity-50">Pr√≥xima</button>
        </div>
    </div>

    <div x-show="buscaRealizada && resultados.length === 0 && !loading" 
        class="text-center py-8 text-gray-500">
        Nenhum resultado encontrado para sua busca.
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function buscaApp() {
    return {
        termo: '',
        tipo: '',
        categoria: '',
        resultados: [],
        loading: false,
        buscaRealizada: false,
        pagina: 1,
        totalResultados: 0,
        totalPaginas: 1,

        async buscar() {
            if (this.termo.length < 2 && !this.tipo && !this.categoria) {
                alert('Digite pelo menos 2 caracteres ou selecione um filtro');
                return;
            }
            
            this.loading = true;
            this.buscaRealizada = true;
            
            let url = '/api/fundamentos/';
            const params = new URLSearchParams();
            
            if (this.termo) params.append('search', this.termo);
            if (this.tipo) params.append('tipo', this.tipo);
            if (this.categoria) params.append('categoria', this.categoria);
            params.append('page', this.pagina);
            
            try {
                const response = await fetch(url + '?' + params.toString());
                const data = await response.json();
                
                this.resultados = data.results || data;
                this.totalResultados = data.count || this.resultados.length;
                this.totalPaginas = Math.ceil(this.totalResultados / 50);
            } catch (error) {
                console.error('Erro na busca:', error);
            }
            
            this.loading = false;
        },

        limpar() {
            this.termo = '';
            this.tipo = '';
            this.categoria = '';
            this.resultados = [];
            this.buscaRealizada = false;
            this.pagina = 1;
        },

        async paginaAnterior() {
            if (this.pagina > 1) {
                this.pagina--;
                await this.buscar();
            }
        },

        async proximaPagina() {
            if (this.pagina < this.totalPaginas) {
                this.pagina++;
                await this.buscar();
            }
        }
    }
}
</script>
{% endblock %}
