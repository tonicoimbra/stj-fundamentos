{% extends 'fundamentos/base.html' %}

{% block title %}Árvore Hierárquica - STJ Fundamentos Legais{% endblock %}

{% block content %}
<div x-data="arvoreApp()" x-cloak class="space-y-6">
    <!-- Header -->
    <div class="bg-gradient-to-r from-green-900 via-green-700 to-green-600 text-white rounded-2xl shadow-lg p-6 md:p-8">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
                <p class="text-sm uppercase tracking-wide text-green-100 mb-2">Visualização Hierárquica</p>
                <h1 class="text-2xl md:text-3xl font-bold">Estrutura em Árvore</h1>
                <p class="text-green-100 text-sm mt-2">
                    Explore a hierarquia completa dos fundamentos legais com navegação interativa.
                </p>
            </div>
            <div class="flex flex-wrap gap-2 text-xs md:text-sm">
                <span class="bg-white/15 border border-white/20 px-3 py-2 rounded-full flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122"></path>
                    </svg>
                    Clique para expandir
                </span>
                <span class="bg-white/15 border border-white/20 px-3 py-2 rounded-full flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"></path>
                    </svg>
                    Carregamento dinâmico
                </span>
            </div>
        </div>
    </div>

    <!-- Controls -->
    <div class="bg-white rounded-xl shadow p-4 md:p-6 border border-gray-100">
        <div class="flex flex-col md:flex-row gap-4 items-start md:items-center justify-between">
            <!-- Filter -->
            <div class="flex-1 w-full md:w-auto">
                <label for="tipo-filter" class="block text-sm font-medium text-gray-700 mb-2">
                    Filtrar por Tipo de Recurso
                </label>
                <select
                    id="tipo-filter"
                    @change="window.location.href = '?tipo=' + $event.target.value"
                    class="w-full md:w-64 border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-green-500 focus:border-transparent transition"
                    aria-label="Filtrar árvore por tipo de recurso">
                    {% for t in tipos %}
                    <option value="{{ t.value }}" {% if t.value == tipo_atual %}selected{% endif %}>
                        {{ t.label }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <!-- Action buttons -->
            <div class="flex flex-wrap gap-2 w-full md:w-auto">
                <button
                    @click="expandirTodos"
                    class="flex-1 md:flex-none px-4 py-3 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition flex items-center justify-center gap-2 touch-manipulation"
                    aria-label="Expandir todos os nós">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    <span class="hidden sm:inline">Expandir Todos</span>
                    <span class="sm:hidden">Expandir</span>
                </button>
                <button
                    @click="recolherTodos"
                    class="flex-1 md:flex-none px-4 py-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition flex items-center justify-center gap-2 touch-manipulation"
                    aria-label="Recolher todos os nós">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path>
                    </svg>
                    <span class="hidden sm:inline">Recolher Todos</span>
                    <span class="sm:hidden">Recolher</span>
                </button>
                <button
                    @click="buscarNaArvore"
                    class="px-4 py-3 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition flex items-center gap-2 touch-manipulation"
                    aria-label="Buscar na árvore"
                    data-tooltip="Ctrl+F para buscar">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Search bar (collapsible) -->
        <div x-show="buscaAberta"
            x-transition:enter="transition ease-out duration-200"
            x-transition:enter-start="opacity-0 transform -translate-y-2"
            x-transition:enter-end="opacity-100 transform translate-y-0"
            class="mt-4 pt-4 border-t">
            <div class="relative">
                <input
                    type="text"
                    x-model="termoBusca"
                    @input="filtrarArvore"
                    @keyup.escape="buscaAberta = false; termoBusca = ''"
                    class="w-full border border-gray-300 rounded-lg px-4 py-3 pr-10 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition"
                    placeholder="Buscar na árvore por descrição ou SEQ..."
                    aria-label="Buscar na árvore">
                <button
                    @click="buscaAberta = false; termoBusca = ''"
                    class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600"
                    aria-label="Fechar busca">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <p class="text-xs text-gray-500 mt-2" x-show="termoBusca">
                <span x-text="resultadosFiltrados"></span> resultado(s) encontrado(s)
            </p>
        </div>
    </div>

    <!-- Tree structure -->
    <div class="bg-white rounded-xl shadow-lg p-4 md:p-6 border border-gray-100" role="tree" aria-label="Árvore hierárquica de fundamentos">
        <div class="flex items-center gap-2 mb-4 pb-4 border-b">
            <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path>
            </svg>
            <div>
                <h2 class="text-lg font-semibold">Estrutura Hierárquica</h2>
                <p class="text-sm text-gray-500">{{ raizes|length }} nó(s) raiz</p>
            </div>
        </div>

        <div class="space-y-1" x-show="!carregando">
            {% for raiz in raizes %}
            <div x-data="nodeData({{ raiz.seq }}, '{{ raiz.descricao|escapejs }}')"
                data-seq="{{ raiz.seq }}"
                class="tree-node"
                role="treeitem"
                :aria-expanded="aberto">

                <!-- Root node -->
                <div class="flex items-start gap-2 p-3 rounded-lg hover:bg-gray-50 cursor-pointer transition group"
                    :class="{'bg-yellow-50 ring-2 ring-yellow-300': destacado}"
                    @click="toggle({{ raiz.seq }}, $data)"
                    tabindex="0"
                    @keydown.enter="toggle({{ raiz.seq }}, $data)"
                    @keydown.space.prevent="toggle({{ raiz.seq }}, $data)"
                    @keydown.right="!aberto && toggle({{ raiz.seq }}, $data)"
                    @keydown.left="aberto && toggle({{ raiz.seq }}, $data)">

                    <!-- Expand/collapse button -->
                    <button
                        class="w-8 h-8 flex items-center justify-center text-gray-500 hover:text-gray-700 hover:bg-gray-200 rounded transition shrink-0"
                        aria-label="Expandir ou recolher"
                        tabindex="-1">
                        <svg x-show="!aberto" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                        <svg x-show="aberto" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>

                    <!-- Node info -->
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="font-mono text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded">{{ raiz.seq }}</span>
                            {% if raiz.selecionavel %}
                            <span class="text-xs px-2 py-1 bg-green-100 text-green-800 rounded-full flex items-center gap-1">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                                Selecionável
                            </span>
                            {% endif %}
                        </div>
                        <span class="text-gray-900 font-medium">{{ raiz.descricao }}</span>
                    </div>

                    <!-- Actions -->
                    <div class="flex items-center gap-2 opacity-0 group-hover:opacity-100 transition shrink-0">
                        <a href="{% url 'fundamentos:detalhe' raiz.seq %}"
                            @click.stop
                            class="text-blue-600 hover:text-blue-800 p-2 hover:bg-blue-50 rounded transition"
                            aria-label="Ver detalhes de {{ raiz.descricao }}"
                            data-tooltip="Ver detalhes">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                            </svg>
                        </a>
                    </div>
                </div>

                <!-- Children (loaded dynamically) -->
                <div x-show="aberto"
                    x-transition:enter="transition ease-out duration-200"
                    x-transition:enter-start="opacity-0 transform -translate-y-2"
                    x-transition:enter-end="opacity-100 transform translate-y-0"
                    class="ml-8 border-l-2 border-gray-200 pl-4 mt-1 space-y-1"
                    role="group">

                    <!-- Loading state -->
                    <div x-show="!carregado" class="p-3 text-sm text-gray-500 flex items-center gap-2">
                        <svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        Carregando filhos...
                    </div>

                    <!-- Children nodes -->
                    <template x-for="filho in filhos" :key="filho.seq">
                        <div x-data="nodeData(filho.seq, filho.descricao)"
                            :data-seq="filho.seq"
                            class="tree-node"
                            role="treeitem"
                            :aria-expanded="aberto">

                            <div class="flex items-start gap-2 p-3 rounded-lg hover:bg-gray-50 cursor-pointer transition group"
                                :class="{'bg-yellow-50 ring-2 ring-yellow-300': destacado}"
                                @click="filho.tem_filhos && toggle(filho.seq, $data)"
                                :tabindex="filho.tem_filhos ? 0 : -1"
                                @keydown.enter="filho.tem_filhos && toggle(filho.seq, $data)"
                                @keydown.space.prevent="filho.tem_filhos && toggle(filho.seq, $data)">

                                <!-- Expand/collapse button or spacer -->
                                <div class="w-8 h-8 flex items-center justify-center shrink-0">
                                    <button x-show="filho.tem_filhos"
                                        class="w-8 h-8 flex items-center justify-center text-gray-400 hover:text-gray-600 hover:bg-gray-200 rounded transition"
                                        aria-label="Expandir ou recolher"
                                        tabindex="-1">
                                        <svg x-show="!aberto" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                        </svg>
                                        <svg x-show="aberto" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </button>
                                    <span x-show="!filho.tem_filhos" class="w-2 h-2 bg-gray-300 rounded-full"></span>
                                </div>

                                <!-- Node info -->
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="font-mono text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded" x-text="filho.seq"></span>
                                        <span x-show="filho.selecionavel"
                                            class="text-xs px-2 py-1 bg-green-100 text-green-800 rounded-full flex items-center gap-1">
                                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                            </svg>
                                            Selecionável
                                        </span>
                                        <span x-show="filho.tem_filhos" class="text-xs text-gray-500">
                                            + filhos
                                        </span>
                                    </div>
                                    <span class="text-gray-900" x-text="filho.descricao"></span>
                                </div>

                                <!-- Actions -->
                                <div class="flex items-center gap-2 opacity-0 group-hover:opacity-100 transition shrink-0">
                                    <a :href="'/detalhe/' + filho.seq + '/'"
                                        @click.stop
                                        class="text-blue-600 hover:text-blue-800 p-2 hover:bg-blue-50 rounded transition"
                                        :aria-label="'Ver detalhes de ' + filho.descricao"
                                        data-tooltip="Ver detalhes">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                        </svg>
                                    </a>
                                </div>
                            </div>

                            <!-- Nested children (recursive) -->
                            <div x-show="aberto && filho.tem_filhos"
                                x-transition
                                class="ml-8 border-l-2 border-gray-200 pl-4 mt-1"
                                role="group">
                                <div x-show="!carregado" class="p-2 text-xs text-gray-500">Carregando...</div>
                            </div>
                        </div>
                    </template>

                    <!-- Empty state -->
                    <div x-show="carregado && filhos.length === 0"
                        class="p-3 text-sm text-gray-500 italic">
                        Nenhum filho encontrado
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="text-center py-12 text-gray-500">
                <svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <p class="font-medium">Nenhum fundamento raiz encontrado</p>
                <p class="text-sm mt-1">Tente selecionar outro tipo de recurso</p>
            </div>
            {% endfor %}
        </div>

        <!-- Loading overlay -->
        <div x-show="carregando" class="text-center py-12">
            <svg class="w-12 h-12 mx-auto text-gray-400 animate-spin mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
            <p class="text-gray-500">Carregando árvore...</p>
        </div>
    </div>

    <!-- Help panel -->
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-sm">
        <div class="flex items-start gap-3">
            <svg class="w-5 h-5 text-blue-600 shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <div>
                <p class="font-medium text-blue-900 mb-2">Dicas de navegação</p>
                <ul class="space-y-1 text-blue-800">
                    <li><kbd class="px-2 py-1 bg-white rounded text-xs">Clique</kbd> para expandir/recolher nós</li>
                    <li><kbd class="px-2 py-1 bg-white rounded text-xs">Enter</kbd> ou <kbd class="px-2 py-1 bg-white rounded text-xs">Space</kbd> quando focado</li>
                    <li><kbd class="px-2 py-1 bg-white rounded text-xs">→</kbd> para expandir, <kbd class="px-2 py-1 bg-white rounded text-xs">←</kbd> para recolher</li>
                    <li><kbd class="px-2 py-1 bg-white rounded text-xs">Ctrl+F</kbd> para buscar na árvore</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function arvoreApp() {
    return {
        carregando: false,
        buscaAberta: false,
        termoBusca: '',
        resultadosFiltrados: 0,

        async toggle(seq, data) {
            data.aberto = !data.aberto;

            if (data.aberto && !data.carregado) {
                try {
                    const response = await fetch('/api/fundamentos/' + seq + '/');
                    const detalhe = await response.json();
                    data.filhos = detalhe.filhos || [];
                    data.carregado = true;
                } catch (error) {
                    console.error('Erro ao carregar filhos:', error);
                    data.filhos = [];
                    data.carregado = true;
                }
            }
        },

        expandirTodos() {
            const nodes = document.querySelectorAll('.tree-node');
            nodes.forEach(async (node) => {
                const seq = node.dataset.seq;
                if (seq) {
                    const component = Alpine.$data(node);
                    if (component && !component.aberto) {
                        await this.toggle(parseInt(seq), component);
                    }
                }
            });
        },

        recolherTodos() {
            const nodes = document.querySelectorAll('.tree-node');
            nodes.forEach((node) => {
                const component = Alpine.$data(node);
                if (component) {
                    component.aberto = false;
                }
            });
        },

        buscarNaArvore() {
            this.buscaAberta = !this.buscaAberta;
            if (this.buscaAberta) {
                this.$nextTick(() => {
                    const input = document.querySelector('input[x-model="termoBusca"]');
                    if (input) input.focus();
                });
            } else {
                this.termoBusca = '';
                this.filtrarArvore();
            }
        },

        filtrarArvore() {
            const termo = this.termoBusca.toLowerCase();
            const nodes = document.querySelectorAll('.tree-node');
            let count = 0;

            nodes.forEach((node) => {
                const component = Alpine.$data(node);
                if (!component) return;

                if (!termo) {
                    component.destacado = false;
                    return;
                }

                const seq = String(component.seq || '');
                const desc = String(component.descricao || '').toLowerCase();

                const matches = seq.includes(termo) || desc.includes(termo);
                component.destacado = matches;

                if (matches) {
                    count++;
                    // Expand parent nodes
                    let parent = node.parentElement;
                    while (parent) {
                        if (parent.classList.contains('tree-node')) {
                            const parentComponent = Alpine.$data(parent);
                            if (parentComponent && !parentComponent.aberto) {
                                this.toggle(parentComponent.seq, parentComponent);
                            }
                        }
                        parent = parent.parentElement;
                    }
                }
            });

            this.resultadosFiltrados = count;
        }
    };
}

function nodeData(seq, descricao) {
    return {
        seq: seq,
        descricao: descricao,
        aberto: false,
        filhos: [],
        carregado: false,
        destacado: false
    };
}

// Keyboard shortcuts
document.addEventListener('keydown', (e) => {
    if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
        e.preventDefault();
        const arvore = Alpine.$data(document.querySelector('[x-data="arvoreApp()"]'));
        if (arvore) {
            arvore.buscarNaArvore();
        }
    }
});
</script>
{% endblock %}
